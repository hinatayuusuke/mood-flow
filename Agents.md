
# Agent Instructions（コメント規約・変更出力規約・ドキュメント読み込み規約）

## 0. 固定出力先（必須）
- 変更内容の記録は必ず以下へ出力すること（相対パス基準はリポジトリルート）
  - 出力フォルダ: `./.agent/`
  - 出力ファイル: `./.agent/changes.md`

> ルール:
> - `./.agent/` が無い場合は作成すること
> - `./.agent/changes.md` は **追記（append）** すること（原則上書き禁止）
> - 追記は指示がない限り、リポジトリー内で実行に関係するコードを変更した時をトリガーとする
> - 追記は **1タスク=1エントリ** とし、完了時に必ず記録すること
> - 指示がない限り、`agent/changes.md`は最後の50行だけ確認すること

>`./Doc/`にあるファイルを読み込むためのルール
> - 必ず`-Encoding UTF8`パラメーターで読み込む

> 日本語を含むファイル出力時のルール
> - 日本語を含むファイル出力はすべて UTF-8とする。
> - 文字コードを省略した出力、Shift_JIS 系の使用、日本語の自動変換は禁止。
---


## 1. コメント用の指示（必須）

### 1.1 目的
作成したコードに適切なコメントを書く
コメントは「読む人の判断コストを下げる」ために付与する。  
**What（何をしたか）ではなく Why（なぜそうしたか）** を優先して書く。

### 1.2 コメントの原則（MUST）
- MUST: 既存のコメントスタイル（言語/記法/句読点/行幅）に従う  
- MUST: 自明な処理の言い換えコメントは禁止（コードを読めば分かる内容は書かない）
- MUST: 意図・前提・制約・副作用・例外条件など「非自明な意思決定」だけをコメントする
- MUST: 公開API/外部I/F 変更・仕様変更がある場合は、利用者視点の注意点をコメント/Docに残す
- MUST: セキュリティ/データ損失/互換性に影響する変更は、必ず明示コメントを残す

### 1.3 コメントの推奨タグ（SHOULD）
必要に応じて以下のタグを使い、機械検索可能にする。
- `NOTE:` 補足（仕様上の理由、運用上の注意）
- `WHY:` その実装にした理由（代替案との差分）
- `TODO(#issue):` 将来対応（課題番号や追跡子がある場合は付与）
- `SECURITY:` セキュリティ観点の注意
- `PERF:` 性能観点の注意
- `COMPAT:` 互換性（破壊的変更・移行注意）

例:
- `// WHY: 旧APIは順序保証がないため、ここで安定ソートに寄せる`
- `// SECURITY: 外部入力。必ずサニタイズ済みであることを前提とする`
- `# NOTE: この処理はバッチ時間帯のみ実行される想定`

### 1.4 追加・変更すべきコメントの基準（MUST）
以下に該当する場合はコメント（またはDoc）を追加/更新すること。
- 例外やエッジケースがある（例: null/空/境界値/タイムゾーン）
- 失敗時の挙動が重要（リトライ、フォールバック、部分成功）
- 互換性/移行が絡む（既存利用者が壊れる可能性）
- 「これを変えると壊れる」前提条件がある（暗黙の契約）
- 実装上の制約（外部仕様、既知のバグ回避、ライブラリ制限）

---

## 2. 修正内容の出力指示（必須）

### 2.1 出力タイミング（MUST）
- MUST: 変更（コード/設定）を行った場合、作業完了時に必ず `./.agent/changes.md` へ追記する  

### 2.2 出力フォーマット（MUST）
`./.agent/changes.md` には以下のテンプレートで追記すること。

#### テンプレート

**YYYY-MM-DD HH:MM (Asia/Taipei) — <短い作業タイトル>**

### Summary
- <1行で要約>

### Context / Goal
- <背景>
- <達成したいこと>

### Changes
- <変更点1>
- <変更点2>

### Files Touched
- `<path/to/file1>` — <何をどう変えたか>
- `<path/to/file2>` — <何をどう変えたか>

### Behavioral Impact
- <挙動の変化（利用者影響/互換性/データ影響）>

### Risk & Mitigation
- Risk: <想定リスク>
- Mitigation: <緩和策（ガード、ログ、ロールバック手順等）>

### Tests / Verification
- <実行したテストや確認手順。無い場合は「未実施」と理由>

## 3. 追記事項（SHOULD）

* SHOULD: 仕様変更・破壊的変更がある場合、移行手順（Migration）を追記
* SHOULD: 監視や運用が必要なら、ログ項目/メトリクス/アラート観点を追記
* SHOULD: 未解決の懸念点があれば `Open Questions` を追記

---

## 4. 禁止事項（MUST NOT）

* MUST NOT: `./.agent/changes.md` の既存エントリを改変・削除（明示指示がある場合を除く）
* MUST NOT: 個人情報・秘密情報・トークン等を `changes.md` / patch に出力しない
* MUST NOT: 自明なコメントを増やして可読性を落とさない

---


## 5. 実装案の提出フォーマット

**実装案テンプレート（推奨）**

1. **概要（1–3行）**
2. **ゴール / 非ゴール**（非ゴールを必ず書く）
3. **前提・仮定**（不確実性の扱いを明確化）
4. **現状整理**（現行挙動、関連モジュール、既存制約）
5. **提案アーキテクチャ**

   * コンポーネント構成
   * データフロー / シーケンス（文章で可）
   * 既存パターンへの整合
6. **インターフェース設計**

   * API / 関数 / イベント / Queue / DB スキーマ変更
   * 入出力、エラー、バリデーション
7. **実装手順（ステップ分割）**

   * Step 1…（小さくマージ可能な単位）
   * Feature flag / 段階リリースが必要なら明記

8. **非機能要件チェック**

   * 性能、セキュリティ、可観測性、互換性、運用
9. **リスクと緩和策**

10. **影響範囲**（変更ファイル候補・移行・ドキュメント更新）
11. **Definition of Done**（完了条件のチェックリスト）

---

## 6. SerenaMCP を使う基準（When to use SerenaMCP）

目的：探索漏れ・差分事故・検証漏れを減らし、複数ファイル横断の変更を安全に速く進める。

### 使う（推奨 / MUST）
次のいずれかを満たす場合は SerenaMCP を使う：
- 変更 diff 見込みが **>= 200 行**
- 変更対象が **>= 3 ファイル** または **>= 2 モジュール/レイヤ**（UI/API/DB など）に跨る
- 「直す場所が不明」など **探索が必要**（grep/参照追跡が前提）
- **反復が 3 回以上**になりそう（試行錯誤・切り分け）
- **高リスク領域**：認証/権限/決済/個人情報/データ整合性/本番影響
- テスト・CI を回して **回帰確認が必須**

### 使わない（Not needed）
- **1 ファイル内で完結**し、diff が **<= 100 行**程度で、影響範囲が明確
- 仕様/変更点が明確で、探索や広範囲の参照追跡が不要
- 文言修正・軽微なリファクタなど、壊れても影響が軽い

### 迷ったら（簡易スコア）
以下を満たすごとに 1 点：
- diff >= 200行 / 3ファイル以上 / 2モジュール以上 / テスト更新必要
- 探索必要 / 仕様不確実 / 高リスク / 反復>=3回
判定：**0-2点:不要 / 3-4点:推奨 / 5点+:強く推奨**

### 運用メモ（最小）
- 小さく始めても、**(diff>=200) or (>=3ファイル) or (反復>=3回)** に到達したら SerenaMCP に切替。
- Codex 等で実装しても、**探索・横断・検証**が重い場合は SerenaMCP を併用する。
